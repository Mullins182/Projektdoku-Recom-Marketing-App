% !TEX root = ../Projektdokumentation.tex
\section{Entwurfsphase} 
\label{sec:Entwurfsphase}

\subsection{Architektur}

\subsubsection{Schichtenmodell}
Die Anwendung ist in drei Schichten gegliedert:

\paragraph{Präsentationsschicht (Frontend).}
Aufgabe: Darstellung der Benutzeroberfläche und Entgegennahme von Eingaben.  
Umsetzung über statische Seiten und Skripte (\texttt{public/index.html}, \texttt{public/employee.html}, \texttt{public/redeem.html}, CSS in \texttt{public/css/styles.css}, JavaScript in \texttt{public/js/app.js} und \texttt{public/js/employee.js}).  
Die Kommunikation erfolgt ausschließlich per \texttt{fetch} (JSON) mit der Anwendungsschicht unter \texttt{php/api.php}.  
Für die QR-Code-Erkennung in der Mitarbeiteransicht wird die @zxing-Library eingebunden.

\paragraph{Anwendungsschicht (Controller/Services).}
Aufgabe: Geschäftslogik und Ablaufsteuerung.  
\texttt{php/api.php} dient als Controller und bietet JSON-basierte Endpunkte (\zB \textit{register}, \textit{validate\_voucher}, \textit{redeem\_voucher}, \textit{employee\_login}).  
Die Logik ist in Service-Klassen gekapselt. Dazu gehören:  
\texttt{php/Auth.php} (Authentifizierung),  
\texttt{php/Csrf.php} (\ac{CSRF}-Token),  
\texttt{php/Voucher.php} (Gutschein-Erstellung inkl. QR/PDF),  
\texttt{php/Mailer.php} (E-Mail-Versand und Protokollierung),  
\texttt{php/Crypto.php} (\ac{AES}-256-GCM-Verschlüsselung)  
und \texttt{php/bootstrap.php} (Autoloading, \texttt{.env}, Zeitzone).

\paragraph{Datenzugriffsschicht (Repository/Persistenz).}
Aufgabe: Zugriff auf die MySQL-Datenbank und Persistenz.  
Dies erfolgt zentral über \texttt{php/Database.php} (PDO-Initialisierung).  
Alle Datenbank-Operationen werden mit Prepared Statements umgesetzt (\zB in \texttt{php/api.php}, \texttt{php/Voucher.php}, \texttt{php/Mailer.php}).  
Genutzte Tabellen sind \texttt{users}, \texttt{vouchers}, \texttt{redemptions} und \texttt{mail\_log}.  
Sensible Felder werden verschlüsselt gespeichert (\texttt{users.email\_enc}, \texttt{users.email\_iv}, \texttt{users.email\_tag}).  
Zur Suche wird ein Hash verwendet (\texttt{users.email\_hash}).

\subsubsection{Schichtgrenzen und Kommunikation}
Das Frontend ruft ausschließlich JSON-Endpunkte der Anwendungsschicht auf.  
Direkte Datenbankzugriffe aus dem Frontend finden nicht statt.  
Die Anwendungsschicht greift nur über die Datenzugriffsschicht (PDO) auf die Datenbank zu.  
Authentifizierung und Sitzungsverwaltung liegen in der Anwendungsschicht.  
\ac{CSRF}-Schutz wird über Token realisiert.

\subsubsection{Diagramm}
Zur Visualisierung des Aufbaus dient Abbildung~\ref{fig:architektur_schichten}.

\begin{figure}[H]
  \centering
  \begin{tikzpicture}[node distance=0cm,outer sep=0pt]
    % Präsentation
    \node[draw, fill=blue!15, minimum width=10cm, minimum height=2cm, align=center] (frontend) {Präsentationsschicht\\[0.2cm] 
    HTML, CSS, JavaScript, QR-Code-Scanner};
    
    % Anwendung
    \node[draw, fill=green!15, minimum width=10cm, minimum height=3cm, align=center, below=of frontend, yshift=-0.5cm] (application) {Anwendungsschicht\\[0.2cm] 
    \texttt{api.php}, Controller \& Services\\
    (Auth, Voucher, Mailer, Crypto, Csrf)};
    
    % Daten
    \node[draw, fill=orange!15, minimum width=10cm, minimum height=2cm, align=center, below=of application, yshift=-0.5cm] (database) {Datenzugriffsschicht\\[0.2cm] 
    \texttt{Database.php}, MySQL (users, vouchers, redemptions, mail\_log)};
    
    % Labels
    \node[below=of database, yshift=0.5cm] (label) {};
  \end{tikzpicture}
  \caption{Schichtenarchitektur der Anwendung}
  \label{fig:architektur_schichten}
\end{figure}

\newpage
